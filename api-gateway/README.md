# API Gateway для образовательной платформы

API Gateway - это компонент, который обеспечивает единую точку входа для всех клиентских запросов к микросервисам образовательной платформы.

## Функциональность

- Проксирование запросов к соответствующим микросервисам
- Обеспечение идемпотентности запросов для предотвращения дублирования
- Единый интерфейс для взаимодействия с разными сервисами
- Подробное логирование для отладки

## Архитектура

API Gateway взаимодействует со следующими сервисами:

- **Auth Service** (порт 8080) - отвечает за аутентификацию и авторизацию
- **Auth GRPC Service** (порт 9090) - gRPC интерфейс для проверки прав доступа
- **Edu Service** (порт 8081) - управление образовательным контентом
- **Game Service** (порт 8083) - геймификация с мини-игрой "кликер"

## Эндпоинты

API Gateway поддерживает следующие маршруты:

- `/api/v1/auth/*` - проксирует запросы к Auth Service
- `/api/v1/courses/*` - проксирует запросы к Edu Service
- `/api/v1/admin/*` - проксирует запросы к Edu Service (административные функции)
- `/api/v1/game/*` - проксирует запросы к Game Service
- `/health` - проверка работоспособности API Gateway

## Особенности проксирования

API Gateway сохраняет оригинальные пути запросов, так как микросервисы уже настроены на обработку полных путей с префиксами `/api/v1/{service}`.

Например, запрос к `/api/v1/auth/register` будет направлен на Auth Service с тем же путем `/api/v1/auth/register`.

## Запуск

### Запуск с помощью Docker Compose

```bash
docker-compose up -d
```

Это запустит API Gateway вместе с другими необходимыми сервисами.

### Запуск локально

```bash
go run cmd/app/main.go
```

## Отладка

API Gateway включает подробное логирование для отладки проблем с маршрутизацией и прокси-запросами:

- Логирование входящих запросов
- Логирование исходящих запросов к микросервисам
- Логирование ответов от микросервисов
- Логирование ошибок при работе с прокси

## Конфигурация

Настройки API Gateway можно изменить через переменные окружения:

- `API_GATEWAY_PORT` - порт API Gateway (по умолчанию 8090)
- `AUTH_SERVICE_URL` - URL для Auth Service (по умолчанию http://auth-service:8080)
- `AUTH_GRPC_SERVICE_URL` - URL для Auth GRPC Service (по умолчанию auth-service:9090)
- `EDU_SERVICE_URL` - URL для Edu Service (по умолчанию http://edu-service:8081)
- `GAME_SERVICE_URL` - URL для Game Service (по умолчанию http://game-service:8083)

## Идемпотентность запросов

API Gateway реализует механизм идемпотентности для предотвращения дублирования запросов. Это особенно важно для edu и game сервисов, где ранее наблюдались проблемы с дублирующимися запросами при использовании Swagger.

Принцип работы:
1. Для каждого запроса создается уникальный ключ на основе HTTP метода, пути и тела запроса
2. Ответ сохраняется в кэше на основе этого ключа
3. При получении повторного запроса с тем же ключом, возвращается сохраненный ответ вместо выполнения нового запроса 